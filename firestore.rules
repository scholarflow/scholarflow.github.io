rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------------------------------------------
    // Helper Functions
    // -----------------------------------------------------------------

    function isBanned() {
      return exists(/databases/$(database)/documents/artifacts/scholarflow-dac0e/moderation/banned_users/main/$(request.auth.uid));
    }

    function isSuspended() {
      return exists(/databases/$(database)/documents/artifacts/scholarflow-dac0e/moderation/suspended_users/main/$(request.auth.uid));
    }

    // Check if the user is the owner of the existing document
    function isOwner(resourceData) {
      return resourceData.authorId == request.auth.uid || (resourceData.uid == request.auth.uid);
    }

    // Ensure the user cannot change the authorId field during an update
    function preservesOwnership() {
      return request.resource.data.authorId == request.auth.uid;
    }

    // Allows a non-owner to update a document only for reporting it.
    function isFlaggingAction() {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['flagged', 'flaggedReason'])
             && request.resource.data.flagged == true;
    }

    // -----------------------------------------------------------------
    // 1. Private User Data (Notes, Todos)
    // -----------------------------------------------------------------
    match /artifacts/{appId}/users/{userId}/{collectionName}/{document=**} {
      allow read: if request.auth != null
                  && request.auth.uid == userId
                  && !isBanned();

      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && !isBanned()
                   && !isSuspended();
    }

    // -----------------------------------------------------------------
    // 2. Public Data
    // -----------------------------------------------------------------

    // --- A. Profiles ---
    match /artifacts/{appId}/public/data/profiles/{userId} {
      allow read: if request.auth != null && !isBanned();

      allow create: if request.auth != null
                   && request.auth.uid == userId
                   && !isBanned()
                   && !isSuspended();

      allow update: if request.auth != null
                   && !isBanned()
                   && !isSuspended()
                   && (
                      request.auth.uid == userId
                      || isFlaggingAction()
                   );

      // Owner can delete their own public profile record.
      allow delete: if request.auth != null
                   && !isBanned()
                   && request.auth.uid == userId;
    }

    // --- B. Usernames ---
    match /artifacts/{appId}/public/data/usernames/{username} {
      allow read: if request.auth != null && !isBanned();

      allow create: if request.auth != null
                    && !isBanned()
                    && !isSuspended()
                    && request.resource.data.uid == request.auth.uid;

      allow update: if false;

      // Owner can delete their own username mapping when deleting profile.
      allow delete: if request.auth != null
                    && !isBanned()
                    && resource.data.uid == request.auth.uid;
    }

    // --- C. Shared Notes ---
    match /artifacts/{appId}/public/data/shared_notes/{noteId} {

      allow read: if request.auth != null && !isBanned();

      allow create: if request.auth != null
                    && !isBanned()
                    && !isSuspended()
                    && request.resource.data.authorId == request.auth.uid;

      allow update: if request.auth != null
                    && !isBanned()
                    && !isSuspended()
                    && (
                      (isOwner(resource.data) && preservesOwnership())
                      || isFlaggingAction()
                    );

      allow delete: if request.auth != null
                    && !isBanned()
                    && !isSuspended()
                    && isOwner(resource.data);

      // Comments Sub-collection
      match /comments/{commentId} {

        allow read: if request.auth != null && !isBanned();

        allow create: if request.auth != null
                      && !isBanned()
                      && !isSuspended()
                      && request.resource.data.authorId == request.auth.uid;

        // Owner can edit own comment; community can report a comment.
        allow update: if request.auth != null
                      && !isBanned()
                      && !isSuspended()
                      && (
                        (isOwner(resource.data) && preservesOwnership())
                        || isFlaggingAction()
                      );

        // Delete: The Comment Author OR The Note Owner
        allow delete: if request.auth != null
                      && !isBanned()
                      && !isSuspended()
                      && (
                        isOwner(resource.data)
                        ||
                        get(/databases/$(database)/documents/artifacts/$(appId)/public/data/shared_notes/$(noteId)).data.authorId == request.auth.uid
                      );
      }
    }
  }
}
